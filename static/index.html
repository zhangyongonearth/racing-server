<html>
  <head>
      <!--  -->
    <title>
            hello websocket
    </title>
  </head>

  <body>
        this is a page for testing websocket<br />
        see the functions in console
  </body>
  <script>
    function initClient(token, type, onmessage){
      var ws = new WebSocket('ws://localhost?'+type+'='+token)
      ws.onopen = function() {
        console.log('@open')
      }

      ws.onmessage = function(e) {
        console.log('@message')
        onmessage(e.data)
      }
      ws.onclose = function() {
        console.log('@close')
      }
      ws.onerror = function() {
        console.log('@error')
      }
      return ws
    }
    function Client(type){
      this.token = undefined
      this.ws = undefined
      this.type = type
      this.login = function(token){
        if(this.ws && this.ws.readyState === this.ws.OPEN){
          if(this.token === token){
            return this
          }
          this.ws.close()
        }
        this.token = token
        this.ws = initClient(token, this.type, this.onmessage)
        return this
      }
      this.quit = function(){
        this.ws.close()
      }
      this.onmessage = function(data){
        console.log(data)
      }
      this.send = function(json){
        try{
          this.ws.send(JSON.stringify(json))
        }catch(e){
          this.login(this.token)
        }
      }
    }
    function Zhuchi(){
      Client.call(this, 'zhuchiToken')
      this.showAnswer = function(a){
        this.send({action:'showAnswer', data:a})
      }
      this.onmessage = function(data){
        console.log('this is zhuchi onmessage')
      }
    }
    function Xuanshou(){
      this.token = undefined
      this.ws = undefined
      this.login = function(token){
        if(this.ws && this.ws.readyState === this.ws.OPEN){
          if(this.token === token){
            return this
          }
          this.ws.close()
        }
        this.token = token
        this.ws = initClient(token, 'xuanshouToken', this.onmessage)
        return this
      }
      this.quit = function(){
        this.ws.close()
      }
      this.answer = function(a){
        try{
          this.ws.send(JSON.stringify({action:'answer', data:a}))
        }catch(e){
          this.login(this.token)
        }
      }
      this.onmessage = function(data){
        console.log(data)
      }
    }
  </script>

</html>
